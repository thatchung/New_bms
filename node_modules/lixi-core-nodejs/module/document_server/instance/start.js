/** khởi chạy document */

let LoadInfo = require('../util/load_info');
let LoadModule = require('../util/load_module');
let LoadModel = require('../util/load_model');
let LoadBiz = require('../util/load_biz');
let LoadApi = require('../util/load_api');
let LoadCodeMap = require('../util/load_code_map');
let LoadWiki = require('../util/load_wiki');
let Path = require('path');

module.exports = document =>
    (document.start = async function() {
        if (document.instance) return;

        if (!document.is_data_prepared) {
            if (!document.info.models) document.info.models = [];
            if (!document.info.bizs) document.info.bizs = [];
            if (!document.info.apis) document.info.apis = [];
            if (!document.info.wikis) document.info.wikis = [];

            let aliases = require(Path.join(
                document.info.dir_root,
                './package.json'
            ))._moduleAliases;

            // await LoadInfo({ aliases, document });
            LoadModule({ aliases, document });
            LoadModel({ aliases, document });
            LoadBiz({ aliases, document });
            LoadApi({ aliases, document });
            // LoadCodeMap({ aliases, document });
            LoadWiki({ aliases, document });

            document.is_data_prepared = true;
        }

        document.instance = document.express.listen(document.options.port);
    });
