let CalculateCodeSize = require('./calculate_code_size');
let ListAllFile = require('../../helper/list_all_file');
let Path = require('path');

module.exports = function({ aliases, document }) {
    for (let modu of document.info.modules) {
        let list_dirname_biz = modu.bizs;
        modu.bizs = [];

        for (let dirname of list_dirname_biz) {
            let files = ListAllFile({
                dir: Path.join(modu.dir, dirname),
                extnames: ['.js']
            });

            for (let file of files) {
                let biz_key = file.substr(
                    document.info.dir_module.length + 1
                );

                // #region [find or insert]

                let biz = document.info.bizs.find(x => x.key === biz_key);
                if (!biz) {
                    biz = { key: biz_key };
                    document.info.bizs.push(biz);
                }

                // #endregion

                // #region [set basic infomation]

                biz.file = file;
                biz.name = file
                    .substr(
                        (document.info.dir_module + '/' + modu.name).length + 1
                    )
                    .replace(/\//g, '-');
                biz.group = dirname;
                biz.code_size = CalculateCodeSize({ file: biz.file });

                // #endregion

                // #region [mapping api with module]

                if (!modu.bizs.includes(biz.key)) modu.bizs.push(biz.key);

                // #endregion
            }
        }
    }
};
