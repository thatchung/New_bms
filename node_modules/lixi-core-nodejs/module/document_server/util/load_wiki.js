let ListAllFile = require('../../helper/list_all_file');
let Path = require('path');
let Fs = require('fs');

module.exports = function({ aliases, document }) {
    for (let modu of document.info.modules) {
        modu.wikis = [];

        // #region [tìm các file *.md]

        let files = ListAllFile({
            dir: Path.join(modu.dir),
            extnames: ['.md']
        });

        // #endregion

        for (let file of files) {
            // #region [khởi tạo]

            let key = modu.name + file.substr(modu.dir.length);
            key = key.replace(/\//g, '_');
            key = key.replace(/.md/g, '');

            let wiki = { key, file: file };

            // #endregion

            // #region [lấy metadata]

            let metadata = {};
            let file_content = Fs.readFileSync(file, 'utf8');

            try {
                if (
                    file_content.indexOf('<!--{') >= 0 &&
                    file_content.indexOf('}-->') >= 0
                ) {
                    metadata = file_content.substring(
                        file_content.indexOf('<!--{') + 4,
                        file_content.indexOf('}-->') + 1
                    );

                    metadata = JSON.parse(metadata);
                }
            } catch (e) {}

            Object.assign(wiki, metadata);

            // #endregion

            // #region [các thông tin mặc định]

            if (!wiki.author) wiki.author = modu.author;

            // #endregion

            // #region [ghi nhận]

            document.info.wikis.push(wiki);
            modu.wikis.push(wiki.key);

            // #endregion
        }
    }
};
