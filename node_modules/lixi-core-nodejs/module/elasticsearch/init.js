/** khởi tạo elasticsearch client
 * @param {object} options thông số cấu hình
 * @returns {ElasticsearchClient} client
 */

let Joi = require('../joi/_index');
let Elasticsearch = require('@elastic/elasticsearch');

// #region [schema]

let schema_option = Joi.object({
    node: Joi.string()
        .uri()
        .required()
        .description('url đến server elastic'),
    prefix: Joi.string()
        .description('tiền tố cho index / bảng')
        .default(''),
    postfix: Joi.string()
        .description('hậu tố cho index / bảng')
        .default(''),
    config: Joi.object()
        .description('các cấu hình cho elastic client')
        .default({})
});
schema_option = schema_option.default(schema_option.validate({}).value);

// #endregion

module.exports = expo =>
    (expo.init = function(options = {}) {
        let elastic = {};

        // #region [ghi nhận option]

        elastic.options = Joi.validateValue({ options }, schema_option);

        // #endregion

        // khởi tạo elastic client
        elastic.client = new Elasticsearch.Client(
            Object.assign(
                {
                    node: elastic.options.node
                },
                elastic.options.config
            )
        );

        // cài đặt các method cho đối tượng elastic
        require('./instance/_index')(elastic);

        return elastic;
    });
