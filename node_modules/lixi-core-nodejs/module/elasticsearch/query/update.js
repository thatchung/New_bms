/** cập nhật record */

let Joi = require('../../joi/_index');

// #region [schema]

let schema_options = Joi.object({
    refresh: Joi.string()
        .valid('wait_for', 'true', 'false')
        .default('false')
        .description('các chế độ refresh document')
    // https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-refresh.html#docs-refresh
});
schema_options = schema_options.default(schema_options.validate({}).value);

// #endregion

module.exports = ({ elastic, query }) =>
    (query.update = async function(data, options) {
        options = version = Joi.validateValue({ options }, schema_options);

        let refresh;
        if (options.refresh === 'wait_for') refresh = 'wait_for';
        else if (options.refresh === 'true') refresh = true;
        else refresh = false;

        return (
            await elastic.client.update({
                index: query._body.index,
                type: query._body.type,
                id: query._body.id,
                body: { doc: data },
                refresh
            })
        ).body;
    });
