/** tạo dữ liệu và đồng bộ với elastic */
/* eslint-disable max-len */

module.exports = ({ knex, query }) =>
    (query.insertSyncElastic = async function(
        data,
        options,
        model,
        elasticsearch
    ) {
        if (knex.isTransaction)
            throw new Error(`cannot sync with elastic in transaction`);
        if (!model) model = knex.options.models[this._single.table];
        if (!elasticsearch) elasticsearch = knex.options.elasticsearch;
        if (!elasticsearch)
            throw new Error(
                `cannot sync with elasticsearch when elasticsearch client is undefined`
            );
        if (Array.isArray(data)) throw new Error(`no support for insert list`);

        let inserted = await this.insert(data);

        data.id = inserted[0];
        let es_data = elasticsearch.modelMap({
            data,
            model_field: model ? model.field : undefined,
            model_elastic_map: model ? model.elastic_model_map : undefined
        });

        await elasticsearch
            .query()
            .index(this._single.table)
            .insert(es_data, options);

        return es_data.id;
    });
