/** cập nhật dữ liệu và đồng bộ với elastic */
/* eslint-disable max-len */

module.exports = ({ knex, query }) =>
    (query.updateSyncElastic = async function(
        id,
        data,
        options,
        model,
        elasticsearch
    ) {
        if (knex.isTransaction)
            throw new Error(`cannot sync with elastic in transaction`);
        if (!model) model = knex.options.models[this._single.table];
        if (!elasticsearch) elasticsearch = knex.options.elasticsearch;
        if (!elasticsearch)
            throw new Error(
                `cannot sync with elasticsearch when elasticsearch client is undefined`
            );

        await this.where({ id: id }).update(data);

        let es_data = elasticsearch.modelMap({
            data,
            model_field: model ? model.field : undefined,
            model_elastic_map: model ? model.elastic_model_map : undefined
        });

        await elasticsearch
            .query()
            .index(this._single.table)
            .id(id)
            .update(es_data, options);
    });
